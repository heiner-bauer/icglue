<%
    #----------------------------------------#
    #  ^..^                                  #
    # ( oo )  )~                             #
    #   ,,  ,,                               #
    #----------------------------------------#
    # register file latex template           #
    #----------------------------------------#

%><%
########################################################################
    proc get_padding_size { width string } {
        set string_length [string length $string]
        set padding       [expr {$width - $string_length} ]
        return $padding
    }

    proc tex_escape {string_in} {
        set string_out $string_in
        set string_out [string map [list "\_" "\\_" ] $string_out]
        set string_out [string map [list "\&" "\\&" ] $string_out]
        set string_out [string map [list "\%" "\\%" ] $string_out]
        set string_out [string map [list "\|" "\\|" ] $string_out]
        set string_out [string map [list "\{" "\\\{"] $string_out]
        set string_out [string map [list "\}" "\\\}"] $string_out]
        set string_out [string map [list "\^" "\\^" ] $string_out]
        set string_out [string map [list "\#" "\\#" ] $string_out]
        set string_out [string map [list "\~" "\\~" ] $string_out]
        return $string_out
    }

    proc cnt_required_escapes {string_in} {
        set cnt 0

        set cnt [expr {[llength [split $string_in "\_"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\&"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\%"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\|"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\{"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\}"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\^"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\#"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\~"]]- 1 + $cnt}]
        if {$cnt <0} {
            set cnt 0
        }
        return $cnt
    }

    proc max_array_entry_len_tex {array_list array_entry} {
        set len 0
        foreach i_entry $array_list {
            array set i_a $i_entry
            set i_len [string length $i_a($array_entry)]
            set escapes [cnt_required_escapes $i_a($array_entry)]
            set i_len [expr {$i_len + $escapes}]
            set len [expr {max ($len, $i_len)}]
        }
        return $len
    }

########################################################################
    set register_list [regfile_to_arraylist $obj_id]
    foreach i_register $register_list {
        array set register $i_register
        foreach i_sreg $register(regs) {
            array set sreg $i_sreg
        }
    }
    set rf_name [object_name $obj_id]
    # define table header text
    set header { "Name" "Bits" "R/W" "Function" }
    set column_width { 0 0 0 0}
    set num_column   { 0 1 2 3}

    set len_max_data(0) 0
    set len_max_data(1) 0
    set len_max_data(2) 0
    set len_max_data(3) 0


    foreach_array register $register_list {
        set len_max_tmp(0)  [max_array_entry_len_tex $register(regs) name      ]
        set len_max_tmp(1)  [max_array_entry_len_tex $register(regs) entrybits ]
        set len_max_tmp(2)  [max_array_entry_len_tex $register(regs) type      ]
        set len_max_tmp(3)  [max_array_entry_len_tex $register(regs) comment   ]

        set len_max_data(0) [expr {max ($len_max_tmp(0), $len_max_data(0))}]
        set len_max_data(1) [expr {max ($len_max_tmp(1), $len_max_data(1))}]
        set len_max_data(2) [expr {max ($len_max_tmp(2), $len_max_data(2))}]
        set len_max_data(3) [expr {max ($len_max_tmp(3), $len_max_data(3))}]
    }

    foreach i_column $num_column {
        set text    [lindex $header $i_column ]
        set text    [tex_escape $text ]
        set text    [concat "\\textbf\{" $text "\}"]

        set len_header [string length $text]

        if {$len_header >  $len_max_data($i_column)} {
            lset column_width $i_column $len_header
        } else {
            lset column_width $i_column $len_max_data($i_column)
        }
        set debug [lindex $column_width $i_column]
    }


%><%
########################################################################
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% register file tex file %%%
% the following package is required
% \usepackage{xstring}%
%% include this file in main latex file
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% usage - print full register file
% \begin{RfTable}                   % table header
%   \getRegFILE{<%= $rf_name%>}
% \end{RfTable}                     % table end

%%% usage - print one register of register file
% \begin{RfTable}                   % table header
<%
    foreach_array reg $register_list {
        set regname $reg(name)
    }

%>%    \getRegFILE{<%= $rf_name : $regname%>}
% \end{RfTable}                     % table end

%%% usage - print one sub-register of register in register file
% \begin{RfTable}                   % table header
<%
    set idx 0
    foreach_array reg $register_list {
        foreach_array sreg $reg(regs) {
            set regname $reg(name)
            set sregname $sreg(name)
            if {$idx == 0} {
                %>%    \getRegFILE{<%= $rf_name : $regname : $sregname%>}<%="\n"%><%
            }
        }
        incr idx
    }
%>% \end{RfTable}                     % table end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment {RfTable}{
    \noindent%
    \center%
    \def\tblc{green!15}%
    \rowcolors {1}{}{ \tblc }%
    \tabularx{\textwidth}{|  l c c X |}%
    \hline%
    <%
    #generate table header
    foreach i_column $num_column {
        set text    [lindex $header $i_column ]
        set text    [tex_escape $text ]
        set textbf  "\\textbf\{"
        set end     "\}"
        set text    $textbf$text$end
        set width   [lindex $column_width $i_column]
        set padding [get_padding_size $width $text]

        %><[format "%s%${padding}s"  $text  "" ]><%

        if {$i_column == 3} {
            %><%=\\\\\%%><%
        } else {
            %><%=" \& "%><%
        }
    }
%>
}{
    \hline%
    \endtabularx%
    \endcenter%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<%=\n%><%
%>\newcommand {\getRegFILE}[1]{%
    \IfStrEqCase{#1}{%
    % register list
    {<%=$rf_name%>}{%
<%
    # generate register list
    foreach_array reg $register_list {
        %>        \getReg{<%= $rf_name ":" $reg(name)%>}%<%="\n"%><%
    }

%>    }%
    }
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%subregister list <%="\n"%>
\newcommand {\getReg}[1]{%
\IfStrEqCase{#1}{%
<%
    foreach_array reg $register_list {
        %>    %<%="\n"%><%
        %>    {<%=$rf_name ":" $reg(name)%>}{%<%="\n"%><%
        foreach_array sreg $reg(regs) {
            %>        \getSubReg{<%= $rf_name ":" $reg(name) ":" $sreg(name) %>}%<%="\n"%><%
        }
        %>    }%<%="\n"%><%
    }
%>}
}
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%<%=\n%><%
%>%subregister definition <%="\n"%>
\newcommand {\getSubReg}[1]{%
    \IfStrEqCase{#1}{%
<%  foreach_array reg $register_list {
        foreach_array sreg $reg(regs) {
            %>        {<%=$rf_name ":" $reg(name) ":" $sreg(name)%>}%
        {<%
            #start of line
            foreach i_column $num_column {
            # Name Width Bits Function
                if {$i_column == 0} {
                    set text    [tex_escape $sreg(name)]
                }
                if {$i_column == 1} {
                    set text    [tex_escape $sreg(entrybits)]
                }
                if {$i_column == 2} {
                    set text    [tex_escape $sreg(type)]
                }
                if {$i_column == 3} {
                    set text    [tex_escape $sreg(comment)]
                }
                set width   [lindex $column_width $i_column]
                set padding [get_padding_size $width $text]

                %><[format "%s%${padding}s"  $text  "" ]><%

                if {$i_column < 3} {
                    %> & <%
                }
            }
            %><%="\\\\ \n"%><%
            %><%="        \}\%\n"%><%
        }
    }
%>    }
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register address
\newcommand {\getRegADDR}[1]{%
\IfStrEqCase{#1}{%
<%
    foreach_array reg $register_list {
        %>        {<%=$rf_name ":" $reg(name)%>}{<[format "0x%08x" $reg(address)  ]>}%<%="\n"%><%
    }
%>    }
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
