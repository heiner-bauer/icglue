<%
    #----------------------------------------#
    #  ^..^                                  #
    # ( oo )  )~                             #
    #   ,,  ,,                               #
    #----------------------------------------#
    # register file latex template           #
    #----------------------------------------#

%><%

########################################################################
    proc tex_escape {string_in} {
        set string_out $string_in
        set string_out [string map [list "\_" "\\_"]  $string_out]
        set string_out [string map [list "\&" "\\&"]  $string_out]
        set string_out [string map [list "\%" "\\%"]  $string_out]
        set string_out [string map [list "\|" "\\|"]  $string_out]
        set string_out [string map [list "\{" "\\\{"] $string_out]
        set string_out [string map [list "\}" "\\\}"] $string_out]
        set string_out [string map [list "\^" "\\^"]  $string_out]
        set string_out [string map [list "\#" "\\#"]  $string_out]
        set string_out [string map [list "\~" "\\~"]  $string_out]
        return $string_out
    }

    proc cnt_required_escapes {string_in} {
        set cnt 0

        set cnt [expr {[llength [split $string_in "\_"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\&"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\%"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\|"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\{"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\}"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\^"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\#"]]- 1 + $cnt}]
        set cnt [expr {[llength [split $string_in "\~"]]- 1 + $cnt}]
        if {$cnt <0} {
            set cnt 0
        }
        return $cnt
    }

    proc max_array_entry_len_tex {array_list array_entry} {
        set len 0
        foreach i_entry $array_list {
            array set i_a $i_entry
            set i_len [string length $i_a($array_entry)]
            set escapes [cnt_required_escapes $i_a($array_entry)]
            set i_len [expr {$i_len + $escapes}]
            set len [expr {max ($len, $i_len)}]
        }
        return $len
    }

    proc reg_type {} {
        set type [uplevel 1 {set sreg(type)}]
        if {[regexp -nocase {RW} $type]} {
            return "RW"
        } elseif {[regexp -nocase {R} $type]} {
            return "R"
        } elseif {[regexp -nocase {RS} $type]} {
            return "R"
        } else {
            return "-"
        }
    }
    proc reg_start_bit {} {
        set entrybits [uplevel 1 {set sreg(entrybits)}]
        if {[regexp -nocase {:} $entrybits]} {
            set str [lindex [split $entrybits  ":"] 1]
            return $str
        } else {
            return $entrybits
        }
    }
    proc reg_reset {} {
        set reset [uplevel 1 {set sreg(reset)}]
        set width [uplevel 1 {set sreg(width)}]
        set type  [uplevel 1 {set  sreg(type)}]

        if {$type == "RW" ||  $type == "CRW" ||  $type == "FCRW"} {
            if {$width == 1} {
                set str [string trim $reset "1'b"]
                set str [string trim $str   "1'h"]
                set str [string trim $str   "1'd"]
                return $str
            } elseif {$width == 2} {
                if {[regexp -nocase {b} $reset]} {
                    set str [string trim $reset "2'b"]
                    return  $str
                } else {
                    set str [string trim $reset "2'h"]
                    set str [string trim $str   "2'd"]
                    binary scan [binary format H* $str] B* bits
                    return [string range $bits 6 7]
                }
                return $str
            } elseif {$width == 3} {
                if {[regexp -nocase {b} $reset]} {
                    set str [string trim $reset "3'b"]
                    return  $str
                } else {
                    set str [string trim $reset "3'h"]
                    set str [string trim $str   "3'd"]
                    binary scan [binary format H* $str] B* bits
                    return [string range $bits 5 7]
                }
                return $str
            }
        } elseif { $type == "R" || $type == "RS" || $type == "CR" || $type == "FCR"  } {
            return X
        }

        return [string cat "{" [tex_escape $reset] "}"]
    }
    proc sreg_name {} {
        set name [uplevel 1 {set sreg(name)}]
        if {[regexp -nocase {\-} $name]} {
           return [string map {"\-" "unused"} $name]
        }
        return $name
    }

########################################################################
    set register_list [regfile_to_arraylist $obj_id]
    foreach i_register $register_list {
        array set register $i_register
        foreach i_sreg $register(regs) {
            array set sreg $i_sreg
        }
    }
    set rf_name [object_name $obj_id]
    # define table header text
    #set header { "Name" "Bits" "R/W" "Function" }
    set header { "Register Name" "Address" "Name" "Width" "Access" "Align" "Reset" "Description"}

    set column_width { 0 0 0 0 0 0 0 0 }
    set num_column   { 0 1 2 3 4 5 6 7 }

    set len_max_data(0) 0
    set len_max_data(1) 0
    set len_max_data(2) 0
    set len_max_data(3) 0
    set len_max_data(4) 0
    set len_max_data(5) 0
    set len_max_data(6) 0
    set len_max_data(7) 0

    foreach_array register $register_list {
        foreach_array sreg $register(regs) {
            set len_max_tmp(0)  [max_array_entry_len_tex $register_list  name]
            set len_max_tmp(1)  [max_array_entry_len_tex $register_list  address]
            set len_max_tmp(2)  [max_array_entry_len_tex $register(regs) name]
            set len_max_tmp(3)  [max_array_entry_len_tex $register(regs) width]
            #set len_max_tmp(4)  [max_array_entry_len_tex $register(regs) type]
            set len_max_tmp(4)  2
            set len_max_tmp(5)  [max_array_entry_len_tex $register(regs) entrybits]
            set len_max_tmp(6)  [max_array_entry_len_tex $register(regs) reset]
            set len_max_tmp(7)  [max_array_entry_len_tex $register(regs) comment]

            set len_max_data(0) [expr {max ($len_max_tmp(0), $len_max_data(0))}]
            set len_max_data(1) [expr {max ($len_max_tmp(1), $len_max_data(1))}]
            set len_max_data(2) [expr {max ($len_max_tmp(2), $len_max_data(2))}]
            set len_max_data(3) [expr {max ($len_max_tmp(3), $len_max_data(3))}]
            set len_max_data(4) [expr {max ($len_max_tmp(4), $len_max_data(4))}]
            set len_max_data(5) [expr {max ($len_max_tmp(5), $len_max_data(5))}]
            set len_max_data(6) [expr {max ($len_max_tmp(6), $len_max_data(6))}]
            set len_max_data(7) [expr {max ($len_max_tmp(7), $len_max_data(7))}]
        }
    }

    foreach i_column $num_column {
        set text    [lindex $header $i_column]
        set text    [tex_escape $text]
        set text    [concat "\\textbf\{" $text "\}"]

        set len_header [string length $text]

        if {$len_header >  $len_max_data($i_column)} {
            lset column_width $i_column $len_header
        } else {
            lset column_width $i_column $len_max_data($i_column)
        }
        set debug [lindex $column_width $i_column]
    }


%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% !!! do not modify this file unless you know what you are doing !!!
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\newcommand {\getRegHeader}{Register Name & Address & Name & Width & Access & Align & Reset & Description \\}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\newcommand {\getReg}[1]{%
%\IfStrEqCase{#1}{%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register file
{<%=$rf_name%>}{%
<%  foreach_array reg $register_list {
    %>    \getReg{<%=$rf_name ":" $reg(name) "\}\%\n" %><%
    }
%>}%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register
<%  foreach_array reg $register_list {
        %><%= "\{" $rf_name  ":" $reg(name) "\}\{\%\n"%><%
        foreach_array sreg $reg(regs) {
            if {[regexp -nocase {\-} $sreg(name)]} {
                %>    \getReg{<%=$rf_name ":" $reg(name) ":" [string map {":" "_"} $sreg(entrybits)] "\_unused" "\}\%\n" %><%
            } else {
                %>    \getReg{<%=$rf_name ":" $reg(name) ":"  $sreg(name) "\}\%\n" %><%
            }
        }
        %><%="\}\%\n"%><%
    }
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register content
<%
foreach_array reg $register_list {
    set i_sreg 0
    foreach_array sreg $reg(regs) {
        %><%=
        if {[regexp -nocase {\-} $sreg(name)]} {
            %>    {<%=$rf_name ":" $reg(name) ":" [string map {":" "_"} $sreg(entrybits)] "\_unused" "\}\{" %><%
        } else {
            %>    {<%=$rf_name ":" $reg(name) ":"  $sreg(name) "\}\{" %><%
        }

        if {$i_sreg == 0} {
            %><%= [tex_escape $reg(name)] " \& \\getReg\{" $rf_name  ":" $reg(name) ".addr\} \& "%><%
        } else {
            %>& & <%
        }
        %><%= [tex_escape $sreg(name)] " \& " [tex_escape $sreg(width)] " \& " [tex_escape [reg_type]] " \& " [tex_escape $sreg(entrybits)] " \& " [tex_escape $sreg(reset)] " \& " [tex_escape $sreg(comment)] "\\\\\}\%\n" %><%
        incr i_sreg
    }
}
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register address
<%  foreach_array reg $register_list {
        %><%= "\{" $rf_name  ":" $reg(name) ".addr\}\{"%><[format "0x%08x" $reg(address)]><%= "\}\%\n"%><%
    }
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register diagram
<%  foreach_array reg $register_list {
        %><%= "\{" $rf_name  ":" $reg(name) ".diag\}\{\%\n"%><%

        %>   \begin{register}{H}{<%=[tex_escape $reg(name) ]%>}{<[format "0x%08x" [tex_escape $reg(address)]]><%= "\}%\n" %><%
        %>    \label{reg_<%=$rf_name "_" $reg(name)%>}<%="%\n"%><%
        foreach_array sreg [ lreverse $reg(regs) ] {

            if {[regexp -nocase {\-} $sreg(name)]} {
                %>    \getReg{<%=$rf_name ":" $reg(name) ":" [string map {":" "_"} $sreg(entrybits)] "\_unused" ".diag\}\%\n" %><%
            } else {
                %>    \getReg{<%=$rf_name ":" $reg(name) ":"  $sreg(name) ".diag\}\%\n" %><%
            }
        }
        %>    \reglabel{Reset}%\regnewline%<%="\n"
        %>   \end{register}%<%="\n"
        %><%="\}\%\n"%><%
    }
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register diagram contend
<%  foreach_array reg $register_list {
    foreach_array sreg [lreverse $reg(regs)]  {

        if {[regexp -nocase {\-} $sreg(name)]} {
            %><%= "\{" $rf_name ":" $reg(name) ":" [string map {":" "_"} $sreg(entrybits)] "\_unused" ".diag\}\{" %><%
        } else {
            %><%= "\{" $rf_name  ":" $reg(name) ":" $sreg(name) ".diag\}\{" %><%
        }

        if { [reg_type] == "R"} {
            %>\regfield[gray!15]<%
        } elseif { [reg_type] == "\-"} {
            %>\regfield[gray!70]<%
        } else {
            %>\regfield[white]<%
        }
        %><%= "\{" [tex_escape [sreg_name]] "\}\{"  [tex_escape $sreg(width)] "\}\{"  [tex_escape [reg_start_bit]] "\}\{" [reg_reset] "\}\}\%\n" %><%
    }
}
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register comment
<%  foreach_array reg $register_list {
        %><%= "\{" $rf_name  ":" $reg(name) ".comment\}\{\%\n" %><%
        %>    \noindent <%= "\%\n" %><%
        %>    \begin{tabularx}{\textwidth}{llX}<%= "\%\n" %><%

        foreach_array sreg [lreverse $reg(regs)] {

            if {[regexp -nocase {\-} $sreg(name)]} {
                %><%
            } else {
                %><%="        \\textbf\{" [tex_escape [sreg_name]] "\} \& \(" [tex_escape [reg_type]]  "\) \& " [tex_escape $sreg(comment)] "\\\\\%\n" %><%
            }
        }
        %>    \end{tabularx}<%= "\%\n" %><%
        %><%="\}\%\n"%><%
    }
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%    }
%}

