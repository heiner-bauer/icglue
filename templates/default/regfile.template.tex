<%
    #----------------------------------------#
    #  ^..^                                  #
    # ( oo )  )~                             #
    #   ,,  ,,                               #
    #----------------------------------------#
    # register file latex template           #
    #----------------------------------------#

%><%

########################################################################
    proc tex_escape {string_in} {
        if {$string_in eq "-"} {
          return "---"
        }
        set string_out $string_in
        set string_out [string map [list "\_" "\\_"]  $string_out]
        set string_out [string map [list "\&" "\\&"]  $string_out]
        set string_out [string map [list "\%" "\\%"]  $string_out]
        set string_out [string map [list "\|" "\\|"]  $string_out]
        set string_out [string map [list "\{" "\\\{"] $string_out]
        set string_out [string map [list "\}" "\\\}"] $string_out]
        set string_out [string map [list "\^" "\\^"]  $string_out]
        set string_out [string map [list "\#" "\\#"]  $string_out]
        set string_out [string map [list "\~" "\\~"]  $string_out]
        set string_out [string map [list ">" "$>$"]   $string_out]
        set string_out [string map [list "<" "$<$"]   $string_out]
        return $string_out
    }

    proc max_array_entry_len_tex {array_list array_entry} {
        set len 0
        set tmp_len 0
        foreach_array a $array_list {
            set texttt_len [string length {\texttt{}}]
            if {$array_entry eq "address"} {
                set tmp_len [expr {10 + $texttt_len}]
            } elseif {$array_entry eq "entrybits"} {
                set tmp_len [expr {5 + $texttt_len}]
            } elseif {$array_entry eq "reset"} {
                set tmp_len [expr {12 + $texttt_len}]
            } else {
                set tmp_len [string length [tex_escape $a($array_entry)]]
            }
            max_set len $tmp_len
        }
        return $len
    }

    proc reg_type {} {
        set type [uplevel 1 {set sreg(type)}]
        if {[regexp -nocase {W} $type]} {
            return "RW"
        } elseif {[regexp -nocase {R} $type]} {
            return "R"
        } else {
            return "-"
        }
    }
    proc reg_start_bit {} {
        set entrybits [uplevel 1 {set sreg(entrybits)}]
        if {[regexp -nocase {:} $entrybits]} {
            set str [lindex [split $entrybits  ":"] 1]
            return $str
        } else {
            return $entrybits
        }
    }
    proc reg_reset {{unused "---"}} {
        upvar sreg(reset) reset sreg(width) width sreg(type) type obj_id obj_id


        set rf_mod [ig::db::get_attribute -object $obj_id -attribute "parent"]
        set lang [ig::db::get_attribute -object $rf_mod -attribute "language"]

        if {[regexp -nocase {W} $type]} {
            if {[regexp {verilog} $lang]} {
                lassign [ig::vlog::parse_value $reset] value_parsed value
                if {$value_parsed} {
                    set reset $value
                    if {$value == 0} {
                        set reset 0
                    }
                }
            }
        } else {
            return "$unused"
        }
        return [format {\texttt{%s}} [tex_escape $reset]]
    }

    proc sreg_name {} {
        set name [uplevel 1 {set sreg(name)}]
        if {[regexp -nocase {\-} $name]} {
           return [string map {"\-" "unused"} $name]
        }
        return $name
    }
    proc reg_bits {} {
        upvar sreg(bit_high) bh sreg(bit_low) bl
        if {$bh == $bl} {
            return [format "%5d" $bl]
        } else {
            return [format "%2d:%2d" $bh $bl]
        }
    }

########################################################################
    set register_list [regfile_to_arraylist $obj_id]
    foreach i_register $register_list {
        array set register $i_register
        foreach i_sreg $register(regs) {
            array set sreg $i_sreg
        }
    }
    set rf_name [object_name $obj_id]
    # define table header text
    array set header {
      entry_name "Register Name"
      addr       "Address"
      width      "Width"
      reg_name   "Name"
      type       "Type"
      entrybits  "Bits"
      reset      "Reset"
      comment    "Description"
    }

    set column_width { 0 0 0 0 0 0 0 0 }
    set num_column   { 0 1 2 3 4 5 6 7 }

    set len_max_data(type)       4

    foreach_array register $register_list {
        foreach_array sreg $register(regs) {
            max_set len_max_data(entry_name)  [max_array_entry_len_tex $register_list  name]
            max_set len_max_data(addr)        [max_array_entry_len_tex $register_list  address]
            max_set len_max_data(width)       [max_array_entry_len_tex $register(regs) width]
            max_set len_max_data(reg_name)    [max_array_entry_len_tex $register(regs) name]
            #max_set len_max_data(type)        [max_array_entry_len_tex $register(regs) type]
            max_set len_max_data(entrybits)   [max_array_entry_len_tex $register(regs) entrybits]
            max_set len_max_data(reset)       [max_array_entry_len_tex $register(regs) reset]
            max_set len_max_data(comment)     [max_array_entry_len_tex $register(regs) comment]
        }
    }

    foreach col {entry_name addr width reg_name entrybits comment} {
      set text [tex_escape $header($col)]
      max_set  len_max_data($col) [string length $text]
    }


%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% if file is used standalone commentin the following 2 commands:
%\usepackage{filecontents}
%\newcommand {\getReg}[1]{
%    \InputIfFileExists{#1}{}{
%        \textbf{\\ \textcolor{red}{ {\LaTeX} error: \textbackslash getReg() failed to find requested information!}}
%    }
%}
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register address list
<%
foreach_array reg $register_list {
    %><%= "\\begin\{filecontents\}\{" $rf_name ":" $reg(name) ".addr.tex\} \n" %><%
    %><%= "    " %><[format "0x%08x" $reg(address)]><%= "\%\n" %><%
    %><%= "\\end\{filecontents\}\n"%><%
}
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register diagram
<%  foreach_array reg $register_list {
        %><%= "\\begin\{filecontents\}\{" $rf_name ":" $reg(name) ".diag.tex\}\n"
        %>   \begin{register}{H}{<%=[tex_escape $reg(name) ]%>}{<[format "0x%08x" [tex_escape $reg(address)]]><%= "\}%\n" %><%
        %>    \begin{regdesc}%<%="%\n"%><%
        %>    \label{reg_<%=$rf_name "_" $reg(name)%>}<%="%\n"%><%
        foreach_array sreg [lreverse $reg(regs) ] {
            if { [reg_type] == "R"} {
                %>      \regfield[gray!15]<%
            } elseif { [reg_type] == "\-"} {
                %>      \regfield[gray!70]<%

            } else {
                %>      \regfield[white]<%
            }
            %><%= "\{" [tex_escape [sreg_name]] "\}\{"  [tex_escape $sreg(width)] "\}\{"  [tex_escape [reg_start_bit]] "\}\{" [reg_reset] "\}\%\n" %><%
        }
        %>    \reglabel{Reset}%\regnewline%<%="\n"
        %>    \end{regdesc}%<%="%\n"%><%
        %>   \end{register}%<%="\n"
        %><%="\\end\{filecontents\}\n\n"%><%
    }
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register comment
<%  foreach_array reg $register_list {
        %><%= "\\begin\{filecontents\}\{" $rf_name ":" $reg(name) ".comment.tex\}\n"
        %>    \noindent <%= "\%\n" %><%
        %>    \begin{center} <%= "\%\n" %><%
        %>    \begin{tabularx}{\textwidth}{llX}<%= "\%\n" %><%
        foreach_array sreg [lreverse $reg(regs)] {

            if {[regexp -nocase {\-} $sreg(name)]} {
                %><%
            } else {
                %><%="        \\textbf\{" [tex_escape [sreg_name]] "\} \& \(" [tex_escape [reg_type]]  "\) \& " [tex_escape $sreg(comment)] "\\\\\%\n" %><%
            }
        }
        %>    \end{tabularx}<%= "\%\n" %><%
        %>    \end{center} <%= "\%\n" %><%
        %><%="\\end\{filecontents\}\n\n"%><%
    }
%>%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% register file table
\begin{filecontents}{<%=$rf_name%>:table.tex}
  <[format [join [list \
    "%-${len_max_data(entry_name)}s" \
    "%-${len_max_data(addr)}s" \
    "%-${len_max_data(reg_name)}s" \
    "%-${len_max_data(type)}s" \
    "%-${len_max_data(entrybits)}s" \
    "%-${len_max_data(reset)}s" \
    "%-${len_max_data(comment)}s" \
  ] " & "] \
    ${header(entry_name)} \
    ${header(addr)} \
    ${header(reg_name)} \
    ${header(type)} \
    ${header(entrybits)} \
    ${header(reset)} \
    ${header(comment)}
  ]> \\ \midrule
<% foreach_array reg $register_list {
      set i_sreg 0
      foreach_array sreg $reg(regs) {
          %><%
          if {$i_sreg == 0} { -%>
  <[format "%-${len_max_data(entry_name)}s" [tex_escape $reg(name)]]> & <[format "%-${len_max_data(addr)}s" [format {\texttt{0x%08x}} $reg(address)]]> & <%-
         } else { -%>
  <[format "%-${len_max_data(entry_name)}s" ""]> & <[format "%-19s" ""]> & <%-
          } -%>
<[format "%-${len_max_data(reg_name)}s"  [tex_escape $sreg(name)]]> & <% -%>
<[format "%-${len_max_data(type)}s"      [tex_escape $sreg(type)]]> & <% -%>
<[format "%-${len_max_data(entrybits)}s" [format {\texttt{%s}} [tex_escape [reg_bits]]]]> & <% -%>
<[format "%-${len_max_data(reset)}s"     [reg_reset]]> & <% -%>
<[format "%-${len_max_data(comment)}s"   [tex_escape $sreg(comment)]]> \\<%="\n"%><%-
        incr i_sreg
    }
}
%>
\end{filecontents}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
